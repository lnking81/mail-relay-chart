{{- range $index, $svc := .Values.services }}
{{- $svcName := include "mail-relay.fullname" $ }}
{{- if $svc.name }}
{{- $svcName = printf "%s-%s" (include "mail-relay.fullname" $) $svc.name }}
{{- end }}
{{- if gt $index 0 }}
---
{{- end }}
apiVersion: v1
kind: Service
metadata:
  name: {{ $svcName }}
  labels:
    {{- include "mail-relay.labels" $ | nindent 4 }}
    {{- if $svc.name }}
    mail-relay/service-name: {{ $svc.name | quote }}
    {{- end }}
  {{- with $svc.annotations }}
  annotations:
    {{- toYaml . | nindent 4 }}
  {{- end }}
spec:
  type: {{ $svc.type | default "ClusterIP" }}
  {{- if and (or (eq $svc.type "LoadBalancer") (eq $svc.type "NodePort")) $svc.externalTrafficPolicy }}
  externalTrafficPolicy: {{ $svc.externalTrafficPolicy }}
  {{- end }}
  {{- if and (eq $svc.type "LoadBalancer") $svc.loadBalancerIP }}
  loadBalancerIP: {{ $svc.loadBalancerIP }}
  {{- end }}
  {{- if and (eq $svc.type "LoadBalancer") $svc.loadBalancerClass }}
  loadBalancerClass: {{ $svc.loadBalancerClass }}
  {{- end }}
  {{- if and (eq $svc.type "LoadBalancer") $svc.loadBalancerSourceRanges }}
  loadBalancerSourceRanges:
    {{- toYaml $svc.loadBalancerSourceRanges | nindent 4 }}
  {{- end }}
  ports:
    - port: {{ $svc.port | default 25 | int }}
      targetPort: smtp-{{ $svc.targetPort | default 25 | int }}
      protocol: TCP
      name: smtp
      {{- if and (eq $svc.type "NodePort") $svc.nodePort }}
      nodePort: {{ $svc.nodePort }}
      {{- end }}
    {{- /* Extra ports for multi-port services (e.g., 25 + 465 on same LB) */ -}}
    {{- range $portIndex, $extraPort := $svc.extraPorts }}
    - port: {{ $extraPort.port | int }}
      targetPort: smtp-{{ $extraPort.targetPort | default $extraPort.port | int }}
      protocol: TCP
      name: {{ $extraPort.name | default (printf "smtp-%d" ($extraPort.port | int)) }}
      {{- if and (eq $svc.type "NodePort") $extraPort.nodePort }}
      nodePort: {{ $extraPort.nodePort }}
      {{- end }}
    {{- end }}
    {{- if or $.Values.metrics.enabled $.Values.dashboard.watch.enabled $.Values.dashboard.logReader.enabled }}
    {{- /* Only add http port to first service to avoid conflicts */ -}}
    {{- if eq $index 0 }}
    - port: {{ $.Values.dashboard.port }}
      targetPort: http
      protocol: TCP
      name: http
    {{- end }}
    {{- end }}
    {{- if and $.Values.adaptiveRate.enabled (eq $index 0) }}
    - port: {{ $.Values.adaptiveRate.metricsPort }}
      targetPort: rate-metrics
      protocol: TCP
      name: rate-metrics
    {{- end }}
  selector:
    {{- include "mail-relay.selectorLabels" $ | nindent 4 }}
{{- end }}
