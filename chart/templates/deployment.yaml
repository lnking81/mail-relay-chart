apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ include "mail-relay.fullname" . }}
  labels:
    {{- include "mail-relay.labels" . | nindent 4 }}
spec:
  replicas: 1
  strategy:
    type: Recreate
  selector:
    matchLabels:
      {{- include "mail-relay.selectorLabels" . | nindent 6 }}
  template:
    metadata:
      annotations:
        checksum/haraka-config: {{ include (print $.Template.BasePath "/configmap-haraka.yaml") . | sha256sum }}
        checksum/scripts: {{ include (print $.Template.BasePath "/configmap-scripts.yaml") . | sha256sum }}
        {{- with .Values.podAnnotations }}
        {{- toYaml . | nindent 8 }}
        {{- end }}
      labels:
        {{- include "mail-relay.selectorLabels" . | nindent 8 }}
        {{- if .Values.podAntiAffinity.enabled }}
        mail-relay/instance-group: {{ .Values.podAntiAffinity.instanceGroup | default "mail-relay" | quote }}
        {{- end }}
        {{- with .Values.podLabels }}
        {{- toYaml . | nindent 8 }}
        {{- end }}
    spec:
      {{- with .Values.imagePullSecrets }}
      imagePullSecrets:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      serviceAccountName: {{ include "mail-relay.serviceAccountName" . }}
      {{- if .Values.terminationGracePeriodSeconds }}
      terminationGracePeriodSeconds: {{ .Values.terminationGracePeriodSeconds }}
      {{- end }}
      securityContext:
        {{- toYaml .Values.podSecurityContext | nindent 8 }}

      {{- if or .Values.dkim.enabled .Values.dns.enabled (and .Values.tls.enabled .Values.tls.selfSigned.enabled (not .Values.tls.existingSecret) (not .Values.tls.certManager.enabled)) }}
      initContainers:
        {{- if and .Values.tls.enabled .Values.tls.selfSigned.enabled (not .Values.tls.existingSecret) (not .Values.tls.certManager.enabled) }}
        # TLS Init Container - generates self-signed certificate
        - name: tls-init
          image: {{ include "mail-relay.image" . | quote }}
          imagePullPolicy: {{ .Values.image.pullPolicy }}
          command: ["/bin/sh", "-c"]
          args:
            - |
              set -e
              CN="{{ .Values.tls.selfSigned.cn | default .Values.mail.hostname }}"
              DAYS="{{ .Values.tls.selfSigned.validDays | default 365 }}"
              echo "Generating self-signed TLS certificate for $CN..."
              openssl req -x509 -nodes -days "$DAYS" -newkey rsa:2048 \
                -keyout /tls/tls.key -out /tls/tls.crt \
                -subj "/CN=$CN" \
                -addext "subjectAltName=DNS:$CN"
              chmod 400 /tls/tls.key
              chmod 444 /tls/tls.crt
              echo "Self-signed certificate generated successfully"
          volumeMounts:
            - name: tls-certs
              mountPath: /tls
          securityContext:
            runAsNonRoot: true
            runAsUser: 1000
            runAsGroup: 1000
            allowPrivilegeEscalation: false
            readOnlyRootFilesystem: true
        {{- end }}
        {{- if .Values.dkim.enabled }}
        # DKIM Init Container - generates keys if not exist
        - name: dkim-init
          image: bitnami/kubectl:latest
          imagePullPolicy: IfNotPresent
          command: ["/bin/bash", "/scripts/init-dkim.sh"]
          env:
            - name: NAMESPACE
              valueFrom:
                fieldRef:
                  fieldPath: metadata.namespace
            - name: KEY_SIZE
              value: "{{ .Values.dkim.keySize }}"
            - name: RELEASE_NAME
              value: "{{ .Release.Name }}"
          volumeMounts:
            - name: scripts
              mountPath: /scripts
              readOnly: true
            - name: dkim-keys
              mountPath: /dkim
          securityContext:
            runAsNonRoot: true
            runAsUser: 1000
            runAsGroup: 1000
            allowPrivilegeEscalation: false
            readOnlyRootFilesystem: true
        {{- end }}
        {{- if .Values.dns.enabled }}
        # DNS Init Container - detects IP, creates DNS, waits for propagation
        - name: dns-init
          image: {{ include "mail-relay.image" . | quote }}
          imagePullPolicy: {{ .Values.image.pullPolicy }}
          command: ["python3", "/app/dns_manager.py", "init"]
          args:
            - --wait-for-lb={{ .Values.dns.watcher.waitForLbTimeout }}
            {{- if .Values.dns.waitForRecords.enabled }}
            - --verify-timeout={{ .Values.dns.waitForRecords.timeout }}
            {{- end }}
          env:
            {{- include "mail-relay.dnsEnvVars" . | nindent 12 }}
          volumeMounts:
            - name: shared
              mountPath: /shared
          securityContext:
            runAsNonRoot: true
            runAsUser: 1000
            runAsGroup: 1000
            allowPrivilegeEscalation: false
            readOnlyRootFilesystem: true
          resources:
            requests:
              cpu: 10m
              memory: 64Mi
            limits:
              cpu: 200m
              memory: 128Mi
        {{- end }}
      {{- end }}

      containers:
        - name: haraka
          image: {{ include "mail-relay.image" . | quote }}
          imagePullPolicy: {{ .Values.image.pullPolicy }}
          command: ["/bin/sh", "/scripts/entrypoint.sh"]
          ports:
            {{- /* Generate unique container ports from services array */ -}}
            {{- $ports := dict }}
            {{- $externalPorts := dict }}
            {{- range .Values.services }}
            {{- $targetPort := .targetPort | default 25 | int }}
            {{- $_ := set $ports (printf "%d" $targetPort) $targetPort }}
            {{- $isInternal := .name }}
            {{- if not $isInternal }}
            {{- $_ := set $externalPorts (printf "%d" $targetPort) $targetPort }}
            {{- range .extraPorts }}
            {{- $epPort := .targetPort | default .port | int }}
            {{- $_ := set $externalPorts (printf "%d" $epPort) $epPort }}
            {{- end }}
            {{- end }}
            {{- end }}
            {{- /* Add implicit TLS port if configured */ -}}
            {{- if .Values.tls.implicitTlsPort }}
            {{- $implicitPort := .Values.tls.implicitTlsPort | int }}
            {{- $_ := set $ports (printf "%d" $implicitPort) $implicitPort }}
            {{- end }}
            {{- range $portStr, $port := $ports }}
            - name: smtp-{{ $port }}
              containerPort: {{ $port }}
              protocol: TCP
              {{- if and ($.Values.hostPort) ($.Values.hostPort.enabled) (hasKey $externalPorts $portStr) }}
              hostPort: {{ $port }}
              {{- end }}
            {{- end }}
            {{- if or .Values.metrics.enabled .Values.dashboard.watch.enabled .Values.dashboard.logReader.enabled }}
            - name: http
              containerPort: {{ .Values.dashboard.port }}
              protocol: TCP
            {{- end }}
            {{- if .Values.adaptiveRate.enabled }}
            - name: rate-metrics
              containerPort: {{ .Values.adaptiveRate.metricsPort }}
              protocol: TCP
            {{- end }}

          livenessProbe:
            exec:
              command:
                - /bin/sh
                - -c
                {{- $firstPort := (first .Values.services).targetPort | default 25 | int }}
                - "test ! -f /shared/kill-pod && nc -z localhost {{ $firstPort }}"
            initialDelaySeconds: 10
            periodSeconds: 30
            timeoutSeconds: 5
            failureThreshold: 3

          readinessProbe:
            tcpSocket:
              {{- $firstPort := (first .Values.services).targetPort | default 25 | int }}
              port: smtp-{{ $firstPort }}
            initialDelaySeconds: 5
            periodSeconds: 10
            timeoutSeconds: 5
            failureThreshold: 3

          env:
            - name: HARAKA_HOSTNAME
              value: {{ .Values.mail.hostname | quote }}
            {{- if .Values.haraka.proxyProtocol.autoDetect }}
            - name: PROXY_PROTOCOL_AUTO_DETECT
              value: "true"
            {{- /* Find first LoadBalancer service for IP detection */ -}}
            {{- $lbService := "" }}
            {{- range $index, $svc := .Values.services }}
            {{- if and (eq .type "LoadBalancer") (not $lbService) }}
            {{- $lbService = $svc }}
            {{- end }}
            {{- end }}
            {{- if $lbService }}
            {{- $svcName := include "mail-relay.fullname" $ }}
            {{- if $lbService.name }}
            {{- $svcName = printf "%s-%s" (include "mail-relay.fullname" $) $lbService.name }}
            {{- end }}
            - name: SERVICE_NAME
              value: {{ $svcName | quote }}
            {{- else }}
            - name: SERVICE_NAME
              value: {{ include "mail-relay.fullname" . | quote }}
            {{- end }}
            - name: NAMESPACE
              valueFrom:
                fieldRef:
                  fieldPath: metadata.namespace
            {{- end }}
            {{- if .Values.haraka.proxyProtocol.trustedProxies }}
            - name: STATIC_TRUSTED_PROXIES
              value: {{ .Values.haraka.proxyProtocol.trustedProxies | join "," | quote }}
            {{- end }}
            {{- if .Values.redis.enabled }}
            {{- if .Values.redis.existingSecret }}
            - name: REDIS_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: {{ .Values.redis.existingSecret }}
                  key: password
            {{- else if .Values.redis.password }}
            - name: REDIS_PASSWORD
              value: {{ .Values.redis.password | quote }}
            {{- end }}
            {{- end }}

          volumeMounts:
            - name: haraka-config
              mountPath: /app/config-template
              readOnly: true
            - name: scripts
              mountPath: /scripts
              readOnly: true
            - name: config-workdir
              mountPath: /app/config
            {{- if .Values.dkim.enabled }}
            - name: dkim-keys
              mountPath: /app/config/dkim
              readOnly: true
            {{- end }}
            {{- if or .Values.dns.enabled .Values.blacklist.enabled }}
            - name: shared
              mountPath: /shared
              readOnly: true
            {{- end }}
            {{- if .Values.persistence.enabled }}
            - name: data
              mountPath: /data
            {{- end }}
            {{- if .Values.tls.enabled }}
            - name: tls-certs
              mountPath: /app/config/tls
              readOnly: true
            {{- end }}
            - name: tmp
              mountPath: /tmp

          securityContext:
            {{- toYaml .Values.securityContext | nindent 12 }}

          resources:
            {{- toYaml .Values.resources | nindent 12 }}

        {{- if and .Values.dns.enabled .Values.dns.watcher.enabled }}
        # DNS Watcher Sidecar - monitors IP changes and updates DNS
        - name: dns-watcher
          image: {{ include "mail-relay.image" . | quote }}
          imagePullPolicy: {{ .Values.image.pullPolicy }}
          command: ["python3", "/app/dns_watcher.py"]
          args:
            - --interval={{ .Values.dns.watcher.interval }}
            - --shared-dir=/shared
          env:
            {{- include "mail-relay.dnsEnvVars" . | nindent 12 }}
          volumeMounts:
            - name: shared
              mountPath: /shared
          resources:
            requests:
              cpu: 10m
              memory: 64Mi
            limits:
              cpu: 100m
              memory: 128Mi
          securityContext:
            runAsNonRoot: true
            runAsUser: 1000
            runAsGroup: 1000
            allowPrivilegeEscalation: false
            readOnlyRootFilesystem: true
        {{- end }}

        {{- if .Values.blacklist.enabled }}
        # Blacklist Monitor Sidecar - monitors IP and domains against DNSBLs
        - name: blacklist-monitor
          image: {{ include "mail-relay.image" . | quote }}
          imagePullPolicy: {{ .Values.image.pullPolicy }}
          command: ["python3", "/app/blacklist_monitor.py"]
          args:
            - --interval={{ .Values.blacklist.interval }}
            - --metrics-port={{ .Values.blacklist.metricsPort }}
            - --shared-dir=/shared
            {{- if .Values.blacklist.dnsServer }}
            - --dns-server={{ .Values.blacklist.dnsServer }}
            {{- end }}
            {{- if .Values.blacklist.freeOnly }}
            - --free-only
            {{- end }}
          ports:
            - name: bl-metrics
              containerPort: {{ .Values.blacklist.metricsPort }}
              protocol: TCP
          env:
            - name: BLACKLIST_INTERVAL
              value: {{ .Values.blacklist.interval | quote }}
            - name: BLACKLIST_METRICS_PORT
              value: {{ .Values.blacklist.metricsPort | quote }}
            # DNS configuration for premium DNSBLs
            {{- if .Values.blacklist.dnsServer }}
            - name: BLACKLIST_DNS_SERVER
              value: {{ .Values.blacklist.dnsServer | quote }}
            {{- end }}
            {{- if .Values.blacklist.freeOnly }}
            - name: BLACKLIST_FREE_ONLY
              value: "true"
            {{- end }}
            {{- if .Values.blacklist.directQuery }}
            - name: BLACKLIST_DIRECT_QUERY
              value: "true"
            {{- end }}
            # IP blacklists
            - name: BLACKLIST_LISTS
              value: {{ .Values.blacklist.ipLists | join "," | quote }}
            {{- if .Values.blacklist.customIpLists }}
            - name: BLACKLIST_CUSTOM_LISTS
              value: {{ .Values.blacklist.customIpLists | join "," | quote }}
            {{- end }}
            # Domain blacklists
            - name: BLACKLIST_DOMAIN_LISTS
              value: {{ .Values.blacklist.domainLists | join "," | quote }}
            {{- if .Values.blacklist.customDomainLists }}
            - name: BLACKLIST_CUSTOM_DOMAIN_LISTS
              value: {{ .Values.blacklist.customDomainLists | join "," | quote }}
            {{- end }}
            # Domains to check (mail.domains + additionalDomains)
            {{- $domains := list }}
            {{- range .Values.mail.domains }}
            {{- $domains = append $domains .name }}
            {{- end }}
            {{- if .Values.blacklist.additionalDomains }}
            {{- $domains = concat $domains .Values.blacklist.additionalDomains }}
            {{- end }}
            - name: BLACKLIST_DOMAINS
              value: {{ $domains | join "," | quote }}
            {{- if .Values.blacklist.alerts.enabled }}
            - name: BLACKLIST_ALERT_ENABLED
              value: "true"
            - name: BLACKLIST_ALERT_RECIPIENTS
              value: {{ .Values.blacklist.alerts.recipients | join "," | quote }}
            - name: BLACKLIST_ALERT_FROM
              value: {{ .Values.blacklist.alerts.from | default (printf "blacklist-monitor@%s" (first .Values.mail.domains).name) | quote }}
            - name: BLACKLIST_ALERT_SUBJECT_PREFIX
              value: {{ .Values.blacklist.alerts.subjectPrefix | quote }}
            - name: BLACKLIST_ALERT_COOLDOWN_HOURS
              value: {{ .Values.blacklist.alerts.cooldownHours | quote }}
            - name: BLACKLIST_ALERT_SMTP_HOST
              value: {{ .Values.blacklist.alerts.smtp.host | quote }}
            - name: BLACKLIST_ALERT_SMTP_PORT
              value: {{ .Values.blacklist.alerts.smtp.port | quote }}
            {{- end }}
            {{- if .Values.blacklist.webhook.enabled }}
            - name: BLACKLIST_WEBHOOK_ENABLED
              value: "true"
            - name: BLACKLIST_WEBHOOK_URL
              value: {{ .Values.blacklist.webhook.url | quote }}
            - name: BLACKLIST_WEBHOOK_TIMEOUT
              value: {{ .Values.blacklist.webhook.timeout | quote }}
            {{- end }}
          volumeMounts:
            - name: shared
              mountPath: /shared
              readOnly: true
          livenessProbe:
            httpGet:
              path: /health
              port: bl-metrics
            initialDelaySeconds: 10
            periodSeconds: 60
            timeoutSeconds: 5
          readinessProbe:
            httpGet:
              path: /health
              port: bl-metrics
            initialDelaySeconds: 5
            periodSeconds: 30
            timeoutSeconds: 5
          resources:
            {{- toYaml .Values.blacklist.resources | nindent 12 }}
          securityContext:
            runAsNonRoot: true
            runAsUser: 1000
            runAsGroup: 1000
            allowPrivilegeEscalation: false
            readOnlyRootFilesystem: true
        {{- end }}

        {{- with .Values.sidecars }}
        # Custom sidecars
        {{- toYaml . | nindent 8 }}
        {{- end }}

      volumes:
        - name: haraka-config
          configMap:
            name: {{ include "mail-relay.fullname" . }}-haraka
        - name: scripts
          configMap:
            name: {{ include "mail-relay.fullname" . }}-scripts
            defaultMode: 0755
        - name: config-workdir
          emptyDir: {}
        {{- if or .Values.dns.enabled .Values.blacklist.enabled }}
        - name: shared
          emptyDir: {}
        {{- end }}
        {{- if .Values.dkim.enabled }}
        - name: dkim-keys
          emptyDir: {}
        {{- end }}
        {{- if .Values.persistence.enabled }}
        - name: data
          persistentVolumeClaim:
            claimName: {{ .Values.persistence.existingClaim | default (include "mail-relay.fullname" .) }}
        {{- end }}
        {{- if .Values.tls.enabled }}
        - name: tls-certs
          {{- if or .Values.tls.existingSecret .Values.tls.certManager.enabled }}
          secret:
            secretName: {{ include "mail-relay.tlsSecretName" . }}
            defaultMode: 0400
          {{- else if .Values.tls.selfSigned.enabled }}
          emptyDir: {}
          {{- else }}
          emptyDir: {}
          {{- end }}
        {{- end }}
        - name: tmp
          emptyDir: {}

      {{- with .Values.nodeSelector }}
      nodeSelector:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      {{- if or .Values.affinity .Values.podAntiAffinity.enabled }}
      affinity:
        {{- with .Values.affinity }}
        {{- toYaml . | nindent 8 }}
        {{- end }}
        {{- if .Values.podAntiAffinity.enabled }}
        podAntiAffinity:
          {{- if eq .Values.podAntiAffinity.type "hard" }}
          requiredDuringSchedulingIgnoredDuringExecution:
            - labelSelector:
                matchLabels:
                  mail-relay/instance-group: {{ .Values.podAntiAffinity.instanceGroup | default "mail-relay" | quote }}
              topologyKey: {{ .Values.podAntiAffinity.topologyKey | quote }}
          {{- else }}
          preferredDuringSchedulingIgnoredDuringExecution:
            - weight: 100
              podAffinityTerm:
                labelSelector:
                  matchLabels:
                    mail-relay/instance-group: {{ .Values.podAntiAffinity.instanceGroup | default "mail-relay" | quote }}
                topologyKey: {{ .Values.podAntiAffinity.topologyKey | quote }}
          {{- end }}
        {{- end }}
      {{- end }}
      {{- with .Values.tolerations }}
      tolerations:
        {{- toYaml . | nindent 8 }}
      {{- end }}
