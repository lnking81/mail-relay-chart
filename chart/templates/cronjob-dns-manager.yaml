{{- if and .Values.externalDns.enabled .Values.externalDns.autoManageDnsRecords }}
apiVersion: batch/v1
kind: CronJob
metadata:
  name: {{ include "mail-relay.fullname" . }}-dns-manager
  labels:
    {{- include "mail-relay.labels" . | nindent 4 }}
spec:
  schedule: "*/{{ .Values.externalDns.ipCheckInterval | default 5 }} * * * *"
  successfulJobsHistoryLimit: 3
  failedJobsHistoryLimit: 1
  concurrencyPolicy: Forbid
  jobTemplate:
    spec:
      backoffLimit: 0
      template:
        metadata:
          annotations:
            checksum/dns-helper-config: {{ include (print $.Template.BasePath "/configmap-dns-helper.yaml") . | sha256sum }}
            {{- if .Values.dkim.enabled }}
            checksum/opendkim-config: {{ include (print $.Template.BasePath "/configmap-opendkim.yaml") . | sha256sum }}
            {{- end }}
          labels:
            {{- include "mail-relay.selectorLabels" . | nindent 12 }}
            job: dns-manager
        spec:
          restartPolicy: Never
          serviceAccountName: {{ include "mail-relay.serviceAccountName" . }}
          containers:
          - name: dns-manager
            image: "{{ .Values.image.repository }}:{{ .Values.image.tag | default .Chart.AppVersion }}"
            command:
            - /bin/bash
            - -c
            - |
              # Don't exit on errors - log them instead
              # set -e

              echo "ðŸ”„ DNS Manager CronJob - $(date)"
              echo "======================================"

              # Get the mail relay pod name using the deployment name pattern
              POD_NAME=$(kubectl get pods -n {{ .Release.Namespace }} -l app.kubernetes.io/instance={{ .Release.Name }} | grep -E "{{ include "mail-relay.fullname" . }}-[a-f0-9]" | head -1 | awk '{print $1}' 2>/dev/null)

              if [ -z "$POD_NAME" ]; then
                echo "âŒ Mail relay pod not found - will retry on next schedule"
                echo "ðŸŽ‰ DNS management completed with warnings - $(date)"
                exit 0
              fi

              echo "ðŸ“§ Found mail relay pod: $POD_NAME"

              # Check outbound IP from the mail relay pod itself
              echo "ðŸŒ Checking outbound IP from mail relay pod..."
              CURRENT_IP=""

              for service in "https://ifconfig.me/ip" "https://icanhazip.com" "https://ipv4.icanhazip.com"; do
                echo "Trying $service..."
                if IP=$(kubectl exec -n {{ .Release.Namespace }} "$POD_NAME" -- curl -s --connect-timeout 10 --max-time 30 "$service" 2>/dev/null); then
                  if echo "$IP" | grep -E '^[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}$' >/dev/null; then
                    CURRENT_IP="$IP"
                    echo "âœ… Detected outbound IP: $CURRENT_IP"
                    break
                  fi
                fi
                echo "Failed to get valid IP from $service"
              done

              if [ -z "$CURRENT_IP" ]; then
                echo "âŒ Failed to detect outbound IP - will retry on next schedule"
                echo "ðŸŽ‰ DNS management completed with warnings - $(date)"
                exit 0
              fi

              # Check each DNSEndpoint and create/update if needed
              {{- range .Values.mail.domains }}
              DNSENDPOINT_NAME="{{ include "mail-relay.fullname" $ }}-dns-{{ .name | replace "." "-" }}"
              echo "ðŸ” Checking DNSEndpoint: $DNSENDPOINT_NAME"

              {{- if and $.Values.dkim.enabled $.Values.dkim.autoGenerate }}
              # Extract DKIM record if available
              DKIM_RECORD=""
              if kubectl exec -n {{ $.Release.Namespace }} "$POD_NAME" -- test -f /data/dkim-keys/{{ .name }}.txt 2>/dev/null; then
                echo "ðŸ”‘ Extracting DKIM record for {{ .name }}..."
                DKIM_RECORD=$(kubectl exec -n {{ $.Release.Namespace }} "$POD_NAME" -- sh -c 'cat /data/dkim-keys/{{ .name }}.txt | grep -v "^;" | tr -d "\n\t " | sed "s/.*TXT(//" | sed "s/).*$//" | tr -d "\""' 2>/dev/null || echo "")
                if [ -n "$DKIM_RECORD" ]; then
                  echo "âœ… Found DKIM record for {{ .name }}"
                else
                  echo "âš ï¸  DKIM record not ready for {{ .name }}"
                fi
              else
                echo "âš ï¸  DKIM key file not found for {{ .name }}"
              fi
              {{- end }}

              # Check if DNSEndpoint exists
              if kubectl get dnsendpoint "$DNSENDPOINT_NAME" -n {{ $.Release.Namespace }} >/dev/null 2>&1; then
                # DNSEndpoint exists, check if IP needs updating
                STORED_IP=$(kubectl get dnsendpoint "$DNSENDPOINT_NAME" -n {{ $.Release.Namespace }} -o jsonpath='{.spec.endpoints[0].targets[0]}' 2>/dev/null || echo "")

                echo "ðŸ“Š Current outbound IP: $CURRENT_IP"
                echo "ðŸ“Š Stored DNS IP: $STORED_IP"

                {{- if and $.Values.dkim.enabled $.Values.dkim.autoGenerate }}
                # Check if DKIM record exists in DNSEndpoint
                DKIM_EXISTS=$(kubectl get dnsendpoint "$DNSENDPOINT_NAME" -n {{ $.Release.Namespace }} -o jsonpath='{.spec.endpoints[?(@.dnsName=="{{ .dkimSelector | default "mail" }}._domainkey.{{ .name }}")].dnsName}' 2>/dev/null || echo "")

                if [ -n "$DKIM_RECORD" ] && [ -z "$DKIM_EXISTS" ]; then
                  echo "ðŸ”‘ Adding DKIM record to existing DNSEndpoint for {{ .name }}..."
                  # Add DKIM record to existing DNSEndpoint
                  kubectl patch dnsendpoint "$DNSENDPOINT_NAME" -n {{ $.Release.Namespace }} --type='json' -p="[
                    {\"op\": \"add\", \"path\": \"/spec/endpoints/-\", \"value\": {\"dnsName\": \"{{ .dkimSelector | default "mail" }}._domainkey.{{ .name }}\", \"recordTTL\": {{ $.Values.externalDns.ttl }}, \"recordType\": \"TXT\", \"targets\": [\"$DKIM_RECORD\"]}}
                  ]" 2>/dev/null && echo "âœ… Added DKIM record to DNSEndpoint"
                fi
                {{- end }}

                if [ "$CURRENT_IP" != "$STORED_IP" ]; then
                  echo "ðŸ”„ IP changed! Updating DNS records for {{ .name }}..."

                  # Update A record and SPF record
                  kubectl patch dnsendpoint "$DNSENDPOINT_NAME" -n {{ $.Release.Namespace }} --type='json' -p="[
                    {\"op\": \"replace\", \"path\": \"/spec/endpoints/0/targets/0\", \"value\": \"$CURRENT_IP\"},
                    {\"op\": \"replace\", \"path\": \"/spec/endpoints/2/targets/0\", \"value\": \"v=spf1 ip4:$CURRENT_IP a:{{ include "mail-relay.externalDnsHostname" $ }} ~all\"}
                  ]"

                  if [ $? -eq 0 ]; then
                    echo "âœ… Updated DNS records for {{ .name }} with IP: $CURRENT_IP"
                  else
                    echo "âŒ Failed to update DNS records for {{ .name }}"
                  fi
                else
                  echo "âœ… IP unchanged for {{ .name }}, no update needed"
                fi
              else
                # DNSEndpoint doesn't exist, create it
                echo "ðŸ†• Creating new DNSEndpoint for {{ .name }}..."

                # Get the deployment UID for owner reference
                DEPLOYMENT_UID=$(kubectl get deployment {{ include "mail-relay.fullname" $ }} -n {{ $.Release.Namespace }} -o jsonpath='{.metadata.uid}' 2>/dev/null || echo "")

                cat << EOF | kubectl apply -f -
              apiVersion: externaldns.k8s.io/v1alpha1
              kind: DNSEndpoint
              metadata:
                name: $DNSENDPOINT_NAME
                namespace: {{ $.Release.Namespace }}
                labels:
                  app.kubernetes.io/name: {{ include "mail-relay.name" $ }}
                  app.kubernetes.io/instance: {{ $.Release.Name }}
                  app.kubernetes.io/version: {{ $.Chart.AppVersion }}
                  app.kubernetes.io/managed-by: {{ $.Release.Service }}
                  helm.sh/chart: {{ include "mail-relay.chart" $ }}
                  dns-domain: {{ .name }}
              spec:
                endpoints:
                # A Record for mail server
                - dnsName: {{ $.Values.mail.hostname }}
                  recordTTL: {{ $.Values.externalDns.ttl }}
                  recordType: A
                  targets:
                  - "$CURRENT_IP"
                # MX Record
                - dnsName: {{ .name }}
                  recordTTL: {{ $.Values.externalDns.ttl }}
                  recordType: MX
                  targets:
                  - "10 {{ $.Values.mail.hostname }}"
                # SPF Record
                - dnsName: {{ .name }}
                  recordTTL: {{ $.Values.externalDns.ttl }}
                  recordType: TXT
                  targets:
                  - "v=spf1 ip4:$CURRENT_IP a:{{ $.Values.mail.hostname }} ~all"
                # DMARC Record
                - dnsName: _dmarc.{{ .name }}
                  recordTTL: {{ $.Values.externalDns.ttl }}
                  recordType: TXT
                  targets:
                  - "{{ $.Values.externalDns.dmarcPolicy }}"
                {{- if and $.Values.dkim.enabled $.Values.dkim.autoGenerate }}
                # DKIM Record (if available)
                $(if [ -n "$DKIM_RECORD" ]; then
                  echo "- dnsName: {{ .dkimSelector | default "mail" }}._domainkey.{{ .name }}"
                  echo "  recordTTL: {{ $.Values.externalDns.ttl }}"
                  echo "  recordType: TXT"
                  echo "  targets:"
                  echo "  - \"$DKIM_RECORD\""
                fi)
                {{- end }}
              EOF
                if [ $? -eq 0 ]; then
                  echo "âœ… Created DNSEndpoint for {{ .name }} with IP: $CURRENT_IP"
                else
                  echo "âŒ Failed to create DNSEndpoint for {{ .name }}"
                fi
              fi
              {{- end }}

              echo "ðŸŽ‰ DNS management completed - $(date)"
            resources:
              requests:
                memory: "128Mi"
                cpu: "100m"
              limits:
                memory: "256Mi"
                cpu: "500m"
{{- end }}
